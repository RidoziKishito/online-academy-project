{{#fillContent 'css'}}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<link href="https://releases.transloadit.com/uppy/v5.1.5/uppy.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/css/course-content.css">
{{/fillContent}}

{{#fillContent 'js'}}
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="/js/course-content.js" defer></script>
<script>
    // --- SỬA LỖI: Sửa ID cho đúng ---
    new Cleave('#currentPrice', { // <-- Sửa từ #txtPrice
        numeral: true,
        numeralThousandsGroupStyle: 'thousand'
    });

    new Cleave('#originalPrice', { // <-- Sửa từ #txtQuantity
        numeral: true,
        numeralThousandsGroupStyle: 'thousand'
    });
    // -------------------------------

    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Compose an epic...'
    });

    // Ensure hidden input contains initial editor content in case user doesn't change it
    const initialHtml = quill.root.innerHTML;
    const fullDescInput = document.querySelector('#full_description');
    if (fullDescInput) fullDescInput.value = initialHtml;

    // On submit, copy quill html to hidden input so server receives full_description
    document.querySelector('#frmAddCourse').addEventListener('submit', function (e) {
        const html = quill.root.innerHTML;
        document.querySelector('#full_description').value = html;
    });

    // Update thumbnail preview when image URL input changes
    const imageUrlInput = document.querySelector('#imageUrlInput');
    const thumbnailPreview = document.querySelector('#thumbnailPreview');
    if (imageUrlInput && thumbnailPreview) {
        imageUrlInput.addEventListener('input', function () {
            const v = imageUrlInput.value && imageUrlInput.value.trim();
            const fallback = `https://picsum.photos/seed/${thumbnailPreview.dataset.courseId}/400/200`;
            thumbnailPreview.src = v || fallback;
        });
    }

    // Handle category selection changes
    const parentCategorySelect = document.getElementById('parentCategory');
    if (parentCategorySelect) {
        const loadSubcategories = async (categoryId) => {
            const container = document.getElementById('subcategoryContainer');
            if (!categoryId) {
                container.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/instructor/api/categories/${categoryId}/subcategories`);
                if (!response.ok) throw new Error('Failed to fetch subcategories');

                const subcategories = await response.json();
                // console.log('Loaded subcategories:', subcategories); // Debug log

                if (subcategories && subcategories.length > 0) {
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.name = 'subcategory_id';
                    select.id = 'subcategory';

                    select.innerHTML = `
                        <option value="">-- Select Sub Category --</option>
                        ${subcategories.map(sub => `<option value="${sub.category_id}">${sub.name}</option>`).join('')}
                    `;

                    container.innerHTML = '';
                    container.appendChild(select);
                } else {
                    container.innerHTML = '';
                }
            } catch (err) {
                console.error('Error loading subcategories:', err);
                container.innerHTML = '<div class="text-danger">Failed to load subcategories</div>';
            }
        };

        // Load subcategories for initial selection
        if (parentCategorySelect.value) {
            loadSubcategories(parentCategorySelect.value);
        }

        // Handle change event
        parentCategorySelect.addEventListener('change', function () {
            loadSubcategories(this.value);
        });
    }
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
  document.body.addEventListener('click', async function (e) {
    const btn = e.target.closest('.btn-hide-course');
    if (!btn) return;

    e.preventDefault();

    const courseId = btn.dataset.courseId;
    // Prefer data-status attribute; fallback to button text
    let status = (btn.dataset.status || '').toString().trim().toLowerCase();
    if (!status) {
      status = btn.textContent.trim().toLowerCase() === 'show' ? 'hide' : 'active';
      // note: fallback guess — better to provide data-status in template
    }

    // If status indicates hidden, action is 'show', otherwise action is 'hide'
    const action = (status === 'hide' || status === 'hidden') ? 'show' : 'hide';
    const confirmTitle = action === 'hide' ? 'Ẩn khóa học?' : 'Hiện khóa học?';
    const confirmText = action === 'hide'
      ? 'Khóa học sẽ bị ẩn khỏi trang học viên (không xóa dữ liệu).'
      : 'Khóa học sẽ được đưa về trạng thái hiển thị cho học viên.';

    const result = await Swal.fire({
      title: confirmTitle,
      text: confirmText,
      icon: action === 'hide' ? 'warning' : 'question',
      showCancelButton: true,
      confirmButtonText: action === 'hide' ? 'Có, ẩn' : 'Có, hiện',
      cancelButtonText: 'Hủy'
    });

    if (!result.isConfirmed) return;

    try {
      // disable button while processing
      btn.disabled = true;

      const headers = { 'Content-Type': 'application/json' };
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      if (csrfMeta) headers['CSRF-Token'] = csrfMeta.content;

      const resp = await fetch(`/instructor/courses/${action}`, {
        method: 'POST',
        headers,
        credentials: 'include',
        body: JSON.stringify({ course_id: courseId })
      });

      let payload = null;
      try { payload = await resp.json(); } catch (err) { payload = null; }

      if (!resp.ok) {
        const msg = (payload && payload.message) || `HTTP ${resp.status}`;
        throw new Error(msg);
      }

      // Success: update button UI (no full reload)
      const successMsg = (payload && payload.message) || (action === 'hide' ? 'Đã ẩn khóa học.' : 'Đã hiện khóa học.');
      await Swal.fire({ icon: 'success', title: 'Thành công', text: successMsg, timer: 1100, showConfirmButton: false });

      // Update data-status and text on button
      if (action === 'hide') {
        btn.dataset.status = 'hide';     // or 'hidden' if you prefer
        btn.textContent = 'Show';
        // optional: change style to indicate hidden (you can adjust classes)
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
      } else {
        btn.dataset.status = 'approved'; // or 'active'
        btn.textContent = 'Hide';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
      }

      // optionally reload the page instead of toggling UI:
      // window.location.reload();
    } catch (err) {
      console.error('Hide/Show error', err);
      Swal.fire({ icon: 'error', title: 'Lỗi', text: err.message || 'Có lỗi xảy ra.' });
    } finally {
      btn.disabled = false;
    }
  });
});
</script>



{{/fillContent}}
<div class="container mt-4">
    <h4 class="mb-3">Manage Course: {{course.title}}</h4>

    <ul class="nav nav-tabs mb-3" id="manageCourseTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab-course">Course Info</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-content">Course Content</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-students">Students</a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- COURSE INFO TAB -->
        <div class="tab-pane fade show active" id="tab-course">
            <div class="card mb-3">
                <div class="card-body">
                    <form id="frmAddCourse" action="/instructor/update-course/{{course.course_id}}" method="POST">
                        {{#if flash}}
                        <div class="mb-3">
                            {{#if flash.success}}<div class="alert alert-success">{{flash.success}}</div>{{/if}}
                            {{#if flash.error}}<div class="alert alert-danger">{{flash.error}}</div>{{/if}}
                        </div>
                        {{/if}}
                        <div class="mb-3">
                            <label class="form-label">Course Title</label>
                            <input type="text" name="title" class="form-control" value="{{course.title}}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <!-- Quill requires a container element; render existing HTML into it -->
                            <div id="editor" class="form-control" style="min-height:200px">{{{course.full_description}}}
                            </div>
                            <input type="hidden" id="full_description" name="full_description" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Thumbnail Image URL</label>
                            <div class="row g-2 align-items-center">
                                <div class="col-md-4">
                                    <img id="thumbnailPreview" data-course-id="{{course.course_id}}"
                                        src="{{#if course.image_url}}{{course.image_url}}{{else}}https://picsum.photos/seed/{{course.course_id}}/400/200{{/if}}"
                                        alt="Thumbnail" class="img-fluid rounded border"
                                        style="max-height:160px;object-fit:cover;" />
                                </div>
                                <div class="col-md-8">
                                    <input type="text" id="imageUrlInput" name="image_url" class="form-control"
                                        value="{{course.image_url}}"
                                        placeholder="https://picsum.photos/seed/123/400/200" />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Price</label>
                                <input id="currentPrice" type="text" name="price" class="form-control"
                                    value="{{course.price}}" placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sale Price</label>
                                <input id="originalPrice" type="text" name="sale_price" class="form-control"
                                    value="{{course.sale_price}}" placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Category</label>
                                <div class="category-selection">
                                    <div class="mb-2">
                                        <select name="category_id" class="form-select" id="parentCategory">
                                            <option value="">-- Select Main Category --</option>
                                            {{#each parentCategories}}
                                            <option value="{{category_id}}" {{#ifEq category_id
                                                ../course.category_id}}selected{{/ifEq}}>{{name}}</option>
                                            {{/each}}
                                        </select>
                                    </div>
                                    <div id="subcategoryContainer">
                                        {{#if subcategories.length}}
                                        <select name="subcategory_id" class="form-select" id="subcategory">
                                            <option value="">-- Select Sub Category --</option>
                                            {{#each subcategories}}
                                            <option value="{{category_id}}" {{#ifEq category_id
                                                ../course.subcategory_id}}selected{{/ifEq}}>{{name}}</option>
                                            {{/each}}
                                        </select>
                                        {{/if}}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <button type="submit" name="status" value="completed" class="btn btn-success" {{#if
                                    course.is_complete}}disabled{{/if}}>Mark Completed</button>
                                <button type="submit" name="status" value="incomplete" class="btn btn-secondary"
                                    {{#unless course.is_complete}}disabled{{/unless}}>Mark Incomplete</button>
                            </div>
                            <span>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button"
                                    class="btn btn-warning btn-hide-course"
                                    data-course-id="{{course.course_id}}"
                                    data-status="{{course.status}}">
                            {{#ifEq2 course.status 'hidden'}}
                                Show
                            {{else}}
                                Hide
                            {{/ifEq2}}
                            </button>
                            </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- CONTENT TAB -->
        <div class="tab-pane fade" id="tab-content">
            {{> course-content course=course chapters=chapters}}
        </div>

        <!-- STUDENTS TAB -->
        <div class="tab-pane fade" id="tab-students">
            <div class="card">
                <div class="card-header">
                    Students Enrolled ({{students.length}})
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Student</th>
                                <th>Email</th>
                                <th>Progress</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each students}}
                            <tr>
                                <td>{{@index}}</td>
                                <td>{{full_name}}</td>
                                <td>{{email}}</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                            style="width: {{progress_percent}}%" aria-valuenow="{{progress_percent}}"
                                            aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small>{{progress_percent}}%</small>
                                </td>
                                <td class="text-end">
                                    <a href="/instructor/student-progress/{{../course.course_id}}/{{user_id}}"
                                        class="btn btn-outline-primary btn-sm">
                                        View Detail
                                    </a>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">No students yet.</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>