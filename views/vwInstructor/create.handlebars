{{#fillContent 'css'}}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<link href="https://releases.transloadit.com/uppy/v5.1.5/uppy.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .image-preview {
        max-height: 200px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .required-field::after {
        content: " *";
        color: red;
    }
</style>
{{/fillContent}}

{{#fillContent 'js'}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script>
    // --- FIX: Correct field IDs ---
    new Cleave('#currentPrice', { // <-- Fixed from #txtPrice
        numeral: true,
        numeralThousandsGroupStyle: 'thousand'
    });

    new Cleave('#originalPrice', { // <-- Fixed from #txtQuantity
        numeral: true,
        numeralThousandsGroupStyle: 'thousand'
    });
    // -------------------------------

    const quillDescription = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write the full course description...'
    });

    const quillRequirements = new Quill('#requirementsEditor', {
        theme: 'snow',
        placeholder: 'What are the requirements or prerequisites for this course?'
    });

    // Handle category selection changes
    const parentCategorySelect = document.getElementById('parentCategory');
    if (parentCategorySelect) {
        parentCategorySelect.addEventListener('change', async function () {
            const categoryId = this.value;
            const container = document.getElementById('subcategoryContainer');
            container.innerHTML = ''; // Clear current subcategories

            if (!categoryId) return;

            try {
                const response = await fetch(`/instructor/api/categories/${categoryId}/subcategories`);
                if (!response.ok) throw new Error('Failed to fetch subcategories');

                const subcategories = await response.json();

                if (subcategories && subcategories.length > 0) {
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.name = 'subcategory_id';
                    select.id = 'subcategory';

                    select.innerHTML = `
                        <option value="">-- Select Sub Category --</option>
                        ${subcategories.map(sub =>
                        `<option value="${sub.category_id}">${sub.name}</option>`
                    ).join('')}
                    `;

                    container.appendChild(select);
                }
            } catch (err) {
                console.error('Error loading subcategories:', err);
                container.innerHTML = '<div class="text-danger small">Failed to load subcategories</div>';
            }
        });
    }

    // Preview images when URLs change
    function updateImagePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);

        input.addEventListener('input', function () {
            const url = this.value.trim();
            if (url) {
                preview.src = url;
            } else {
                // Use external placeholder to avoid local 404s
                preview.src = previewId === 'imagePreview'
                  ? 'https://via.placeholder.com/800x450?text=Course+Image'
                  : 'https://via.placeholder.com/1600x600?text=Cover+Image';
            }
        });
    }

    updateImagePreview('imageUrl', 'imagePreview');
    updateImagePreview('largeImageUrl', 'largeImagePreview');

    function parseVnd(val){
        if (val == null) return 0;
        const n = String(val).replace(/[^0-9]/g, '');
        return n ? Number(n) : 0;
    }

    function isQuillEmpty(quill){
        const text = (quill && quill.getText && quill.getText().trim()) || '';
        // Quill empty often returns "\n"
        return text.length === 0;
    }

    // Handle form submission with validation + AJAX
    document.querySelector('#frmAddCourse').addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = this;

        // Get content from editors
        const descriptionHtml = quillDescription.root.innerHTML;
        document.querySelector('#full_description').value = descriptionHtml;

        const requirementsHtml = quillRequirements.root.innerHTML;
        document.querySelector('#requirements').value = requirementsHtml;

        // Collect inputs
        const title = form.elements['title']?.value?.trim() || '';
        const shortDesc = form.elements['short_description']?.value?.trim() || '';
        const imageUrl = form.elements['image_url']?.value?.trim() || '';
        const categoryId = form.elements['category_id']?.value?.trim() || '';
        const priceStr = document.getElementById('originalPrice')?.value?.trim() || '';
        const saleStr = document.getElementById('currentPrice')?.value?.trim() || '';
        const price = parseVnd(priceStr);
        let sale = saleStr ? parseVnd(saleStr) : price; // default sale to price if empty

        const errors = [];

        // Native validity first (for URL pattern, required, etc.)
        if (!form.checkValidity()) {
            // Aggregate simple messages
            if (!title) errors.push('Course Title is required.');
            if (!shortDesc) errors.push('Brief Summary is required.');
            if (isQuillEmpty(quillDescription)) errors.push('Full Description is required.');
            if (!imageUrl) errors.push('Course Image URL is required.');
            if (!categoryId) errors.push('Category is required.');
        } else {
            // Even if HTML5 valid, enforce quill empty check
            if (isQuillEmpty(quillDescription)) errors.push('Full Description is required.');
        }

        // Price validations
        if (!Number.isFinite(price) || price < 0) {
            errors.push('Original Price must be a non-negative number.');
        }
        if (!Number.isFinite(sale) || sale < 0) {
            errors.push('Current Price must be a non-negative number.');
        }
        if (Number.isFinite(price) && Number.isFinite(sale) && sale > price) {
            errors.push('Current Price cannot be greater than Original Price.');
        }

        if (errors.length > 0) {
            if (window.Swal) {
                Swal.fire({
                    icon: 'error',
                    title: 'Please fix the following',
                    html: `<ul style="text-align:left;margin:0;padding-left:18px;">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`
                });
            } else {
                alert(errors.join('\n'));
            }
            return;
        }

        // Build form data and submit via AJAX
        const saveType = e.submitter?.value;
        const status = saveType === 'draft' ? 'draft' : 'pending';

        // Ensure status field exists
        let statusInput = form.querySelector('input[name="status"]');
        if (!statusInput){
            statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            form.appendChild(statusInput);
        }
        statusInput.value = status;

        const fd = new FormData(form);
        // Normalize numbers to plain integer strings
        fd.set('price', String(price));
        fd.set('sale_price', String(sale));
        fd.set('full_description', descriptionHtml);
        fd.set('requirements', requirementsHtml);

        // Disable submit buttons to avoid double submit
        const submitBtns = form.querySelectorAll('button[type="submit"], button[form="frmAddCourse"]');
        submitBtns.forEach(b => b.disabled = true);

        try {
            // Send as application/x-www-form-urlencoded so server (express.urlencoded) can parse correctly
            const params = new URLSearchParams();
            for (const [k, v] of fd.entries()) {
                params.append(k, typeof v === 'string' ? v : String(v));
            }
            const resp = await fetch(form.action, {
                method: 'POST',
                body: params.toString(),
                redirect: 'follow',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (resp.redirected) {
                // Server redirected to success page
                if (window.Swal) {
                    await Swal.fire({ icon: 'success', title: 'Course created', timer: 900, showConfirmButton: false });
                }
                window.location.href = resp.url;
                return;
            }
            if (!resp.ok) {
                const ct = resp.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    const data = await resp.json().catch(() => ({}));
                    const msg = (data && (data.message || data.error || data.errors && JSON.stringify(data.errors))) || `HTTP ${resp.status}`;
                    throw new Error(msg);
                }
                if (ct.includes('text/plain')) {
                    const text = await resp.text();
                    throw new Error(text || `HTTP ${resp.status}`);
                }
                // Fallback for HTML or unknown responses: don't dump full HTML into Swal
                throw new Error('Create failed. Please review the form and try again.');
            }
            // Fallback: success without redirect
            if (window.Swal) {
                await Swal.fire({ icon: 'success', title: 'Course created', timer: 900, showConfirmButton: false });
            }
            window.location.href = '/instructor';
        } catch (err) {
            const msgRaw = err && err.message ? String(err.message) : 'An error occurred.';
            // Avoid showing raw HTML in the popup
            const looksLikeHtml = /<[^>]+>/.test(msgRaw);
            const msg = looksLikeHtml ? 'Create failed. Please check required fields or try again.' : msgRaw;
            if (window.Swal) {
                Swal.fire({ icon: 'error', title: 'Create failed', text: msg });
            } else {
                alert(msg);
            }
        } finally {
            submitBtns.forEach(b => b.disabled = false);
        }
    });
</script>
{{/fillContent}}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="fa fa-plus-circle me-2"></i> Create New Course</h5>
                        <small class="text-muted">Fill in the information below to create a new course</small>
                    </div>
                </div>
                <div class="card-body">
                    <form id="frmAddCourse" action="/instructor/create" method="POST">
                        {{#if flash}}
                        <div
                            class="alert {{#if flash.success}}alert-success{{else}}alert-danger{{/if}} alert-dismissible fade show">
                            {{#if flash.success}}{{flash.success}}{{else}}{{flash.error}}{{/if}}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {{/if}}

                        <div class="mb-3">
                            <label class="form-label required-field">Course Title</label>
                            <input type="text" name="title" class="form-control" required maxlength="500"
                                value="{{oldData.title}}" placeholder="Enter an engaging course title">
                        </div>

                        <div class="mb-3">
                            <label class="form-label required-field">Brief Summary</label>
                            <input type="text" name="short_description" class="form-control" required
                                value="{{oldData.short_description}}"
                                placeholder="Write a compelling summary of your course (1-2 sentences)">
                            <small class="text-muted">This will appear in course cards and search results</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label required-field">Full Description</label>
                            <div id="editor" style="min-height: 200px">{{{oldData.full_description}}}</div>
                            <input type="hidden" id="full_description" name="full_description" />
                            <small class="text-muted">Describe what students will learn, course content, requirements,
                                etc.</small>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label required-field">Course Image</label>
                                <input type="url" id="imageUrl" name="image_url" class="form-control mb-2" required
                                    value="{{oldData.image_url}}" placeholder="URL of course thumbnail image">
                                <img id="imagePreview"
                                    src="{{#if oldData.image_url}}{{oldData.image_url}}{{else}}https://via.placeholder.com/800x450?text=Course+Image{{/if}}"
                                    alt="Course thumbnail preview" class="image-preview w-100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Large Cover Image</label>
                                <input type="url" id="largeImageUrl" name="large_image_url" class="form-control mb-2"
                                    value="{{oldData.large_image_url}}"
                                    placeholder="URL of course cover image (optional)">
                                <img id="largeImagePreview"
                                    src="{{#if oldData.large_image_url}}{{oldData.large_image_url}}{{else}}https://via.placeholder.com/1600x600?text=Cover+Image{{/if}}"
                                    alt="Course cover preview" class="image-preview w-100">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label required-field">Category</label>
                                <select name="category_id" class="form-select" id="parentCategory" required>
                                    <option value="">-- Select Main Category --</option>
                                    {{#each parentCategories}}
                                    <option value="{{category_id}}" {{#if (eq ../oldData.category_id
                                        category_id)}}selected{{/if}}>
                                        {{name}}
                                    </option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Subcategory</label>
                                <div id="subcategoryContainer">
                                    {{#if subcategories.length}}
                                    <select name="subcategory_id" class="form-select" id="subcategory">
                                        <option value="">-- Select Sub Category --</option>
                                        {{#each subcategories}}
                                        <option value="{{category_id}}" {{#if (eq ../oldData.subcategory_id
                                            category_id)}}selected{{/if}}>
                                            {{name}}
                                        </option>
                                        {{/each}}
                                    </select>
                                    {{/if}}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Original Price (VND)</label>
                                <div class="input-group">
                                    <span class="input-group-text">₫</span>
                                    <input type="text" id="originalPrice" name="price" class="form-control"
                                        placeholder="399,000" value="{{oldData.original_price}}">
                                </div>
                                {{#if errorMessages.original_price}}<div class="text-danger small">
                                    {{errorMessages.original_price.[0]}}</div>{{/if}}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Current Price (VND)</label>
                                <div class="input-group">
                                    <span class="input-group-text">₫</span>
                                    <input type="text" id="currentPrice" name="sale_price" class="form-control"
                                        placeholder="279,000" value="{{oldData.current_price}}">
                                </div>
                                {{#if errorMessages.current_price}}<div class="text-danger small">
                                    {{errorMessages.current_price.[0]}}</div>{{/if}}
                            </div>

                        </div>

                        <div class="mb-3">
                            <label class="form-label">Course Requirements</label>
                            <div id="requirementsEditor">{{{oldData.requirements}}}</div>
                            <input type="hidden" id="requirements" name="requirements" />
                            {{#if errorMessages.requirements}}<div class="text-danger small">
                                {{errorMessages.requirements.[0]}}</div>{{/if}}
                            <small class="text-muted">Enter course prerequisites, required skills, or materials
                                needed</small>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="/instructor" class="btn btn-outline-secondary">Back</a>
                            <button type="reset" class="btn btn-secondary">Reset</button>
                            <button type="submit" class="btn btn-primary"><i class="fa fa-save me-1"></i> Create
                                Course</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>