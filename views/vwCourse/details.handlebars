<div class="card border-0 shadow-sm rounded-4 overflow-hidden">

  <!-- üß≠ Breadcrumb -->
  <div class="card-header border-0 py-3 text-light">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0 small" style="--bs-breadcrumb-divider-color: white;">
        <li class="breadcrumb-item">
          <a href="/" class="text-light fw-semibold text-decoration-none">Home</a>
        </li>

        {{#if categories.parent.id}}
        <li class="breadcrumb-item">
          <a href="/courses/by-category/{{categories.parent.id}}" class="text-light fw-semibold text-decoration-none">
            {{categories.parent.name}}
          </a>
        </li>
        {{/if}}

        {{#if categories.child.id}}
        <li class="breadcrumb-item">
          <a href="/courses/by-category/{{categories.child.id}}" class="text-light fw-semibold text-decoration-none">
            {{categories.child.name}}
          </a>
        </li>
        {{/if}}

        <li class="breadcrumb-item active text-light" aria-current="page">
          {{course.title}}
        </li>
      </ol>
    </nav>
  </div>

  <!-- üìò Course Body -->
  <div class="card-body p-4">

    <!-- üéì Course Header -->
    <div class="row g-4 align-items-start">
      <div class="col-12">
        <h2 class="fw-bold mb-3">{{course.title}}</h2>
      </div>

      <!-- Left Info -->
      <div class="col-lg-4">

        <!-- Rating + Stats -->
        <div class="mb-3 small text-muted">
          <span class="text-warning me-2">{{{render_stars course.rating_avg}}}</span>
          ({{course.rating_count}} ratings) ‚Ä¢
          <i class="bi bi-people ms-1 me-1"></i>
          <span id="enrollmentCount">{{course.enrollment_count}}</span> students ‚Ä¢
          <i class="bi bi-eye ms-1 me-1"></i>{{course.view_count}}
        </div>


        <p class="lead text-muted">{{course.short_description}}</p>

        <!-- Badges -->
        {{#if course.is_bestseller}}
        <span class="badge bg-warning text-dark rounded-pill px-3 py-2 me-1">üî• Bestseller</span>
        {{/if}}
        {{#if (not is_complete)}}  <span class="badge bg-light text-secondary ms-2">‚è≥ In progress</span>{{/if}}

        <!-- Instructor -->
        <div class="mt-4 d-flex align-items-center">
          <img src="{{course.instructor_avatar}}" alt="Instructor"
               class="rounded-circle me-3 shadow-sm" width="60" height="60">
          <div>
            <div class="fw-semibold">
              Instructor:
              <a href="/instructors/{{course.instructor_id}}" class="text-success text-decoration-none">
                {{course.instructor_name}}
              </a>
            </div>
            <small class="text-muted">
              <i class="bi bi-clock me-1"></i>Updated {{format_date course.updated_at}}
            </small>
          </div>
        </div>
      </div>

      <!-- Right Card -->
      <div class="col-lg-8 d-flex align-items-stretch">
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden flex-fill">
<div class="card-body p-4 d-flex flex-nowrap align-items-center justify-content-between">

            <!-- Left image -->
            <div class="flex-shrink-0 me-4 mb-3">
              <img src="{{#if course.image_url}}{{course.image_url}}{{else}}https://via.placeholder.com/400x250?text=No+Image{{/if}}"
                  alt="{{course.title}}" class="rounded-4 shadow-sm"
                  style="width: 320px; height: 200px; object-fit: cover;">
            </div>

            <!-- Price & Buttons -->
            <div class="flex-grow-1 d-flex flex-column justify-content-center text-center">
              <!-- Price -->
              <div class="mb-3">
                {{#unless (eq course.sale_price course.price)}}
                  <h3 class="text-danger fw-bold mb-0">{{format_number course.sale_price}} VND</h3>
                  <small class="text-muted text-decoration-line-through">{{format_number course.price}} VND</small>
                {{else}}
                  <h3 class="fw-bold mb-0">{{format_number course.price}} VND</h3>
                {{/unless}}
              </div>


              {{#if (eq @root.session.authUser.role 'instructor')}}
              <div class="text-center">
                  <a class="btn btn-primary rounded-pill py-2 px-4 shadow-sm fw-semibold" href="/learn/{{course.id}}">
                    <i class="bi bi-play-circle me-2"></i>Watch
                  </a>
                  <a class="btn btn-warning rounded-pill py-2 px-4 shadow-sm fw-semibold" href="/instructor/manage-course/{{course.id}}">
                    <i class="bi bi-pencil me-2"></i>Edit Course
                  </a>
              </div>
              {{/if}}

              {{#if (eq @root.session.authUser.role 'admin')}}
              <div class="text-center">
                  <a class="btn btn-primary rounded-pill py-2 px-4 shadow-sm fw-semibold" href="/learn/{{course.id}}">
                    <i class="bi bi-play-circle me-2"></i>Watch
                  </a>
              {{/if}}
                
              {{#unless (eq @root.session.authUser.role 'instructor')}}
              {{#unless (eq @root.session.authUser.role 'admin')}}
              <!-- Action buttons -->
                <div class="text-center">
                  {{#if isEnrolled}}
                    <a class="btn btn-primary rounded-pill py-2 px-4 shadow-sm fw-semibold" href="/learn/{{course.id}}">
                      <i class="bi bi-play-circle me-2"></i>Continue learning
                    </a>
                  {{else}}
                  <!-- Row 1: Buy Now -->
                    <div class="d-flex justify-content-center align-items-center mb-3 flex-wrap">

                      {{!-- Replace existing Buy Now button with this block --}}
                      {{#if isEnrolled}}
                      <!-- User enrolled: show Learn button -->
                        <a href="/learn/{{course.course_id}}"
                          class="btn btn-success rounded-pill py-2 fw-semibold me-2">
                          <i class="bi bi-play-circle-fill me-2"></i>Learn
                        </a>
                      {{else}}
                        {{#if @root.session.authUser}}
                          <!-- Logged-in user but not enrolled: open payment modal -->
                          <button type="button"
                                  class="btn btn-outline-success rounded-pill py-2 fw-semibold me-2"
                                  data-bs-toggle="modal"
                                  data-bs-target="#paymentQrModal">
                            <i class="bi bi-lightning-charge-fill me-2"></i>Buy Now
                          </button>
                        {{else}}
                          <!-- User not logged in: redirect same as wishlist (with retUrl) -->
                          <a href="/account/signin?ret={{retUrl}}"
                            class="btn btn-outline-success rounded-pill py-2 fw-semibold me-2">
                            <i class="bi bi-lightning-charge-fill me-2"></i>Buy Now
                          </a>
                        {{/if}}
                      {{/if}}



                      {{#if @root.session.authUser}}
                        {{#if isInWishlist}}
                          <button type="button" class="btn btn-danger rounded-pill py-2" id="wishlistBtn" data-course-id="{{course.id}}">
                            <i class="bi bi-heart-fill"></i>
                            <span id="wishlistText">Remove</span>
                          </button>
                        {{else}}
                          <button type="button" class="btn btn-outline-danger rounded-pill py-2" id="wishlistBtn" data-course-id="{{course.id}}">
                            <i class="bi bi-heart"></i>
                            <span id="wishlistText">Add to Wishlist</span>
                          </button>
                        {{/if}}
                      {{else}}
                      <a href="/account/signin?ret={{retUrl}}" class="btn btn-outline-danger rounded-pill py-2">
                          <i class="bi bi-heart"></i> Add to Wishlist
                        </a>
                      {{/if}}
                    </div>
                  {{/if}}
                </div>
                {{/unless}}
              {{/unless}}


              {{!-- Enroll form for free course (optional) --}}
              {{#if course.is_free}}
                {{#unless isEnrolled}}
                  <form method="POST" action="/courses/detail/{{course.id}}/enroll" class="mt-3">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Enroll for Free</button>
                  </form>
                {{/unless}}
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Course content -->
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-list-ul text-success me-2"></i>Course Content</h4>

      <div class="accordion" id="courseContent">
        {{#each course.sections}}
          <div class="accordion-item border-0 border-bottom">
            <h2 class="accordion-header" id="heading{{@index}}">
              <button class="accordion-button collapsed fw-semibold text-dark" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapse{{@index}}"
                      aria-expanded="false" aria-controls="collapse{{@index}}">
                {{this.title}}
                <span class="badge bg-light text-dark ms-3">{{this.lecture_count}} lectures</span>
              </button>
            </h2>

            <div id="collapse{{@index}}" class="accordion-collapse collapse" aria-labelledby="heading{{@index}}" data-bs-parent="#courseContent">
              <div class="accordion-body p-0">
                <ul class="list-group list-group-flush">
                  {{#each this.lectures}}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        {{#if this.is_previewable}}
                          <a href="javascript:void(0)"
                            class="preview-btn text-decoration-none text-dark me-2"
                            data-video="{{getYouTubeEmbedUrl this.video_url}}">
                            {{this.order_index}}. {{this.title}}
                            <span class="badge bg-success ms-2 small">Preview</span>
                          </a>
                        {{else}}
                          <div class="text-decoration-none text-dark me-2">
                            {{this.order_index}}. {{this.title}}
                          </div>
                        {{/if}}
                      </div>
                      <div>
                        <small class="text-muted">{{this.duration}}</small>
                      </div>
                    </li>
                  {{/each}}
                  {{#unless this.lectures.length}}
                    <li class="list-group-item text-muted small">No lessons yet.</li>
                  {{/unless}}
                </ul>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    </section>

  <!-- ‚úÖ Requirements -->
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-check-circle text-success me-2"></i>Requirements</h4>
      <ul class="list-group list-group-flush">
        {{{course.requirements}}}
      </ul>
    </section>

  <!-- üìù Detailed Description -->
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-file-earmark-text text-success me-2"></i>Detailed Description</h4>
      <div class="p-4 bg-light rounded-4 shadow-sm">
        {{{course.full_description}}}
      </div>
    </section>

  <!-- üí¨ Feedback (Review Form when enrolled) -->
    {{#if isEnrolled}}
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-chat-dots text-success me-2"></i>Student Feedback</h4>

      <!-- Review Form -->
      <div class="card mb-4">
        <div class="card-body">
          <form id="reviewForm">
            <div class="mb-3">
              <label class="form-label">Rating:</label>

              <div class="star-rating d-flex gap-1" style="font-size: 1.5rem; cursor: pointer;">
                <span class="star" data-rating="1"><i class="bi bi-star"></i></span>
                <span class="star" data-rating="2"><i class="bi bi-star"></i></span>
                <span class="star" data-rating="3"><i class="bi bi-star"></i></span>
                <span class="star" data-rating="4"><i class="bi bi-star"></i></span>
                <span class="star" data-rating="5"><i class="bi bi-star"></i></span>
              </div>
              <input type="hidden" id="rating" name="rating" value="0" required>



            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Comment:</label>
              <textarea class="form-control" id="comment" name="comment" rows="4"
                        placeholder="Share your experience...">{{#if userReview}}{{userReview.comment}}{{/if}}</textarea>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
              {{#if userReview}}Update review{{else}}Send{{/if}}
              </button>
              {{#if userReview}}
              <button type="button" class="btn btn-outline-danger" id="deleteReview">Delete review</button>
              {{/if}}
            </div>
          </form>
        </div>
      </div>
    </section>
    {{/if}}

  <!-- üí¨ Feedback Display -->
    <section class="mt-4">
      <h4 class="fw-bold mb-3"><i class="bi bi-chat-square-text text-success me-2"></i>Reviews from Students</h4>
      <div class="row row-cols-1 row-cols-md-3 g-4">
        {{#each course.reviews}}
          <div class="col">
            <div class="card border-0 shadow-sm rounded-4 h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="{{this.avatar}}" class="rounded-circle me-3" width="50" height="50" alt="{{this.name}}">
                  <div>
                    <div class="fw-semibold">{{this.name}}</div>
                    <div class="text-warning small">{{{render_stars this.rating}}}</div>
                  </div>
                </div>
                <p class="text-muted small mb-0">{{this.comment}}</p>
              </div>
            </div>
          </div>
        {{/each}}
        {{#unless course.reviews.length}}
          <div class="col-12">
            <p class="text-muted small">No reviews yet.</p>
          </div>
        {{/unless}}
      </div>
    </section>

    <!-- üë®‚Äçüè´ Instructor -->
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-person-workspace text-success me-2"></i>About the Instructor</h4>
      <div class="card border-0 shadow-lg rounded-4">
        <div class="card-body d-flex flex-wrap align-items-center">
          <img src="{{course.instructor_avatar}}" class="rounded-circle me-4" width="100" height="100">
          <div>
            <h5 class="fw-bold mb-1">{{course.instructor_name}}</h5>
            <p class="text-muted small mb-2">{{course.instructor_bio}}</p>
            <div class="d-flex gap-2 flex-wrap">
              <a href="/instructors/{{course.instructor_id}}" class="btn btn-outline-success rounded-pill btn-sm">
                <i class="bi bi-collection me-1"></i>View More Courses
              </a>
              {{#if isAuthenticated}}
                {{#if (ne authUser.user_id course.instructor_id)}}
                  <button type="button" 
                          class="btn btn-primary rounded-pill btn-sm" 
                          onclick="openChatWithInstructor({{course.instructor_id}}, '{{course.instructor_name}}')">
                    <i class="bi bi-chat-dots me-1"></i>Chat with Instructor
                  </button>
                {{/if}}
              {{else}}
                <a href="/account/signin?ret={{retUrl}}" class="btn btn-outline-primary rounded-pill btn-sm">
                  <i class="bi bi-chat-dots me-1"></i>Chat with Instructor
                </a>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- üîó Related Courses -->
    <section class="mt-5">
      <h4 class="fw-bold mb-3"><i class="bi bi-book text-success me-2"></i>Related Courses</h4>
      <div class="row row-cols-1 row-cols-md-4 g-4">
        {{#each related_courses}}
          <a class="col text-decoration-none" href="/courses/detail/{{this.course_id}}">
            <div class="card border-0 shadow-sm rounded-4 h-100">
              <img src="{{this.image_url}}" class="card-img-top" alt="{{this.title}}"
                   style="width: 100%; height: 180px; object-fit: cover; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
              <div class="card-body">
                <h6 class="fw-semibold text-dark">{{this.title}}</h6>
                <p class="text-muted small mb-1">{{this.instructor_name}}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-warning small">{{{render_stars this.rating_avg}}}</span>
                  <span class="fw-semibold text-danger">{{format_number this.sale_price}}</span>
                </div>
              </div>
            </div>
          </a>
        {{/each}}
      </div>
    </section>

  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-light text-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="bi bi-trash3 text-danger" style="font-size: 3rem;"></i>
        </div>
  <h6>Are you sure you want to delete this review?</h6>
  <p class="text-muted">This action cannot be undone.</p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash3 me-1"></i>Delete review
        </button>
      </div>
    </div>
  </div>
</div>


{{#fillContent 'js'}}
<script>
// Note: global preview video modal is expected to exist on page (id="videoModal" and iframe id="previewVideo")
document.addEventListener('DOMContentLoaded', function () {
  /* ---------- Helpers ---------- */
  function showAlert(message, type = 'success') {
    const existing = document.querySelector('.alert');
    if (existing) existing.remove();
  const title = type === 'success' ? 'Success!' : (type === 'warning' ? 'Warning!' : 'Error!');
    const html = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) reviewForm.insertAdjacentHTML('beforebegin', html);
    else document.body.insertAdjacentHTML('afterbegin', html);
    setTimeout(() => document.querySelector('.alert')?.remove(), 5000);
  }

  /* ---------- Video preview ---------- */
  (function initVideoPreview() {
    const previewBtns = document.querySelectorAll('.preview-btn');
    const videoModalEl = document.getElementById('videoModal');
    const videoIframe = document.getElementById('previewVideo');
    if (!previewBtns.length || !videoModalEl || !videoIframe) return;

    previewBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.video;
        if (!url) return;
        videoIframe.src = url.includes('?') ? url + '&autoplay=1' : url + '?autoplay=1';
        const myModal = new bootstrap.Modal(videoModalEl);
        myModal.show();
      });
    });

    videoModalEl.addEventListener('hidden.bs.modal', () => {
      // stop video playback
      videoIframe.src = '';
    });
  })();

  /* ---------- Wishlist toggle ---------- */
  (function initWishlist() {
    const wishlistBtn = document.getElementById('wishlistBtn');
    if (!wishlistBtn) return;

    wishlistBtn.addEventListener('click', async function () {
      const courseId = this.dataset.courseId;
      const originalClass = this.className;
      const originalContent = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Processing...';

      try {
        const res = await fetch('/courses/wishlist/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ courseId: Number(courseId) || 0 })
        });
        const result = await res.json();

        if (result && result.success) {
          if (result.action === 'added') {
            this.className = 'btn btn-danger rounded-pill py-2';
            this.innerHTML = '<i class="bi bi-heart-fill"></i> <span id="wishlistText">Remove</span>';
          } else {
            this.className = 'btn btn-outline-danger rounded-pill py-2';
            this.innerHTML = '<i class="bi bi-heart"></i> <span id="wishlistText">Add to Wishlist</span>';
          }
        } else {
          this.className = originalClass;
          this.innerHTML = originalContent;
          showAlert('Error: ' + (result?.message || 'Unable to update wishlist.'), 'danger');
        }
      } catch (err) {
  this.className = originalClass;
  this.innerHTML = originalContent;
  showAlert('An error occurred while updating wishlist', 'danger');
        console.error(err);
      } finally {
        this.disabled = false;
      }
    });
  })();

  /* ---------- Stars + Review submit & delete ---------- */
  (function initStarsAndReview() {
    const stars = Array.from(document.querySelectorAll('.star'));
    const ratingInput = document.getElementById('rating');
    const reviewForm = document.getElementById('reviewForm');
    const deleteBtn = document.getElementById('deleteReview');
    const starContainer = document.querySelector('.star-rating');

    const courseId = '{{course.id}}';
    const reviewEndpoint = reviewForm?.getAttribute('action') || `/review/course/${courseId}`;

    function updateStarDisplay(rating) {
      stars.forEach((s, idx) => {
        const icon = s.querySelector("i");
        if (!icon) return;
        if (idx < rating) {
          icon.classList.add("bi-star-fill","text-warning");
          icon.classList.remove("bi-star","text-secondary");
        } else {
          icon.classList.add("bi-star","text-secondary");
          icon.classList.remove("bi-star-fill","text-warning");
        }
      });
    }

    // Initialize visual state
    if (ratingInput) {
      ratingInput.value = Number(ratingInput.value) || 0;
      updateStarDisplay(Number(ratingInput.value) || 0);
    }

    if (stars.length) {
      stars.forEach(star => {
        const starRating = Number(star.dataset.rating) || 0;
        star.addEventListener('mouseenter', function () {
          updateStarDisplay(starRating);
        });
        star.addEventListener('click', function () {
          if (ratingInput) ratingInput.value = starRating;
          updateStarDisplay(starRating);
        });
      });

      if (starContainer) {
        starContainer.addEventListener('mouseleave', () => {
          updateStarDisplay(Number(ratingInput?.value) || 0);
        });
      }
    }

    // Submit review
    function wireFormSubmit() {
      if (!reviewForm) return;
      reviewForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!ratingInput || Number(ratingInput.value) === 0) {
          showAlert('Please select a rating!', 'warning');
          return;
        }

        const data = {
          rating: Number(ratingInput.value),
          comment: document.getElementById('comment')?.value || ''
        };

        const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

        try {
          const resp = await fetch(reviewEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrf ? { 'X-CSRF-Token': csrf } : {})
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          });

          if (!resp.ok) {
            const text = await resp.text().catch(()=>null);
            throw new Error(`HTTP ${resp.status} ${resp.statusText} ${text ? '- '+text : ''}`);
          }

          const result = await resp.json().catch(()=>({ success: false, message: 'Invalid JSON response' }));
          if (result && result.success) {
            showAlert(result.message || 'Review submitted successfully', 'success');
            setTimeout(() => location.reload(), 1200);
          } else {
            showAlert(result?.message || 'Error submitting review', 'danger');
          }
        } catch (err) {
          console.error(err);
          showAlert('An error occurred while submitting the review', 'danger');
        }
      });
    }

    // Delete review
    function wireDelete() {
      if (!deleteBtn) return;
      deleteBtn.addEventListener('click', function () {
        const modalEl = document.getElementById('deleteConfirmModal');
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        if (!confirmBtn) return;

        confirmBtn.addEventListener('click', async function handler() {
          modal.hide();
          const csrf = document.querySelector('meta[name="csrf-token"]')?.content;

          try {
            const resp = await fetch(reviewEndpoint, {
              method: 'DELETE',
              headers: {
                ...(csrf ? { 'X-CSRF-Token': csrf } : {})
              },
              credentials: 'same-origin'
            });

            if (!resp.ok) {
              const text = await resp.text().catch(()=>null);
              throw new Error(`HTTP ${resp.status} ${resp.statusText} ${text ? '- '+text : ''}`);
            }

            const result = await resp.json().catch(()=>({ success: false, message: 'Invalid JSON response' }));
            if (result && result.success) {
              showAlert(result.message || 'Review deleted successfully', 'success');
              setTimeout(() => location.reload(), 1200);
            } else {
              showAlert(result?.message || 'Unable to delete review', 'danger');
            }
          } catch (err) {
            console.error(err);
            showAlert('An error occurred while deleting the review', 'danger');
          }
        }, { once: true });
      });
    }

    wireFormSubmit();
    wireDelete();
  })();

  /* ---------- Chat with Instructor ---------- */
  window.openChatWithInstructor = function(instructorId, instructorName) {
    // Check if chat system is available
    if (typeof window.chatSystem !== 'undefined') {
      window.chatSystem.openChatWithUser(instructorId, instructorName);
    } else {
      // Fallback: show alert and try to initialize chat system
      console.log('Chat system not initialized, attempting to initialize...');
      if (typeof ChatSystem !== 'undefined') {
        window.chatSystem = new ChatSystem();
        window.chatSystem.openChatWithUser(instructorId, instructorName);
      } else {
        alert('Chat system is not available. Please refresh the page and try again.');
      }
    }
  };

}); // DOMContentLoaded
</script>

<script>
// Course view counting after delay
document.addEventListener('DOMContentLoaded', () => {
  const courseId = '{{course.id}}';
  setTimeout(() => {
    fetch(`/courses/view/${courseId}`, { method: 'POST' });
  }, 15000);
});
</script>
{{/fillContent}}


<style>
.spin {
  animation: spin 1s linear infinite;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}


.star i {
  transition: transform 0.15s ease, color 0.15s ease;
}
.star:hover i {
  transform: scale(1.2);
}


</style>


<!-- ===== Payment Modal (bg-light) ===== -->
<div class="modal fade" id="paymentQrModal" tabindex="-1" aria-labelledby="paymentQrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow bg-light text-dark">
      <form id="paymentForm" method="POST" action="/payment/confirm">
        <!-- if using CSRF, insert token here -->
        <div class="modal-body text-center p-4">
          <h5 id="paymentQrModalLabel" class="mb-1 text-success">Order Payment</h5>
          <p class="small text-muted mb-3">Scan the QR code using your banking app or e-wallet to pay.</p>

          <input type="hidden" name="course_id" value="{{course.id}}">
          <input type="hidden" name="price" value="{{#if course.sale_price}}{{course.sale_price}}{{else}}{{course.price}}{{/if}}">

          <div class="my-3">
            <img src="/qr.jpg" alt="QR Payment" class="img-fluid" style="max-width:320px; width:100%; height:auto;" />
          </div>

          <p class="small text-muted mb-3">After scanning and paying, press the button below to confirm.</p>

          <div class="d-flex justify-content-center gap-2">
            <button type="submit" class="btn btn-success rounded-pill px-4 py-2 fw-semibold">
              Paid
            </button>
            <button type="button" class="btn btn-outline-secondary rounded-pill px-3 py-2" data-bs-dismiss="modal">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

