<form id="signinForm" action="" method="post">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Sign In</span>
            <a href="/account/signup" class="small text-decoration-non text-light">Don't have an account? Sign up</a>
        </div>
        <div class="card-body">
            {{#if success}}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Success!</strong> {{success}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {{/if}}
            {{#if error}}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>Error!</strong> Your email or password is incorrect.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
            {{/if}}
            <div class="mb-3">
                <label for="txtEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="txtEmail" name="email" value="{{oldData.email}}" autofocus>
            </div>
            <div class="mb-3">
                <label for="txtPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="txtPassword" name="password">
            </div>
            <div class="mb-3 text-end">
                <a href="/account/forgot-password" class="text-decoration-none text-success small">
                    <i class="bi bi-key-fill me-1"></i>Forgot Password?
                </a>
            </div>
        </div>
        <div class="card-footer text-muted">
        <div class="d-flex text-start align-items-center gap-2">
            <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-in-right"></i> Sign in
            </button>
            <a class="btn btn-outline-dark" href="/auth/google">
            <i class="bi bi-google me-1"></i> Google
            </a>
        </div>
        </div>

    </div>

</form>
{{#fillContent 'js'}}
<script>
window.addEventListener('load', function () {
  const form = document.getElementById('signinForm');
  if (!form) {
    console.warn('‚ö†Ô∏è Sign-in form not found!');
    return;
  }

  function showAlert(icon, title, text, timer = 2000) {
    if (window.Swal)
      return Swal.fire({ icon, title, text, timer, showConfirmButton: false });
    alert(`${title}\n${text}`);
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault(); // üîí Ch·∫∑n reload 100%
    const email = document.getElementById('txtEmail').value.trim();
    const password = document.getElementById('txtPassword').value;

    if (!email || !password)
      return showAlert('error', 'Missing information', 'Email and password are required.');

    if (!isValidEmail(email))
      return showAlert('error', 'Invalid email', 'Please enter a valid email address.');

    if (password.length < 6)
      return showAlert('error', 'Weak password', 'Password must be at least 6 characters.');

    try {
      const res = await fetch('/account/signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const result = await res.json();

      if (res.ok && result.success) {
        showAlert('success', 'Welcome!', 'Sign in successful. Redirecting...');
        setTimeout(() => window.location.href = result.redirect || '/', 1500);
      } else {
        showAlert('error', 'Sign in failed', result.message || 'Invalid email or password.');
      }
    } catch {
      showAlert('error', 'Connection error', 'Unable to reach server.');
    }
  });
});
</script>
{{/fillContent}}