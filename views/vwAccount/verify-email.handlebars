{{#fillContent 'css'}}
<style>
  .auth-container { min-height: 80vh; display: flex; align-items: center; justify-content: center; }
  .auth-card { max-width: 480px; width: 100%; }
</style>
{{/fillContent}}

<div class="container auth-container">
  <div class="auth-card">
    <div class="card shadow">
      <div class="card-body p-4">
        <div class="text-center mb-4">
          <i class="bi bi-envelope-fill text-success" style="font-size: 3rem;"></i>
          <h3 class="mt-3">Verify your email</h3>
          <p class="text-muted">We've sent a 8-character code to your email. Enter it below to activate your account.</p>
        </div>

        {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{error}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {{/if}}

        {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i>
          {{success}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {{/if}}

  <form id="verifyForm" method="post" action="/account/verify-email">
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input type="email" class="form-control" id="email" name="email" value="{{email}}" placeholder="your@email.com" required />
            </div>
          </div>
          <div class="mb-3">
            <label for="token" class="form-label">Verification Code</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-key"></i></span>
              <input type="text" class="form-control text-uppercase" id="token" name="token" placeholder="ABCD1234" maxlength="8" minlength="8" required style="letter-spacing:2px;" />
            </div>
          </div>

          <button type="submit" class="btn btn-success w-100 mb-3">
            <i class="bi bi-check2-circle me-2"></i>Verify Email
          </button>
        </form>

  <form id="resendForm" method="post" action="/account/resend-verification">
          <input type="hidden" name="email" value="{{email}}" />
          <button type="submit" class="btn btn-outline-secondary w-100">
            <i class="bi bi-arrow-clockwise me-2"></i>Resend Code
          </button>
        </form>

        <div class="text-center mt-3">
          <a href="/account/signin" class="text-decoration-none"><i class="bi bi-arrow-left me-1"></i>Back to Sign In</a>
        </div>
      </div>
    </div>
  </div>
</div>

{{#fillContent 'js'}}
<script>
  // Auto-uppercase token
  const tokenInput = document.getElementById('token');
  if (tokenInput) {
    tokenInput.addEventListener('input', function () {
      this.value = this.value.toUpperCase();
    });
  }

  // Handle verify form submit with AJAX + SweetAlert2
  const verifyForm = document.getElementById('verifyForm');
  if (verifyForm) {
    verifyForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const token = document.getElementById('token').value.trim().toUpperCase();
      const btn = verifyForm.querySelector('button[type="submit"]');
      const old = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
      try {
        const res = await fetch('/account/verify-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
          body: `email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`
        });
        const data = await res.json();
        if (data.success) {
          await Swal.fire({ icon: 'success', title: 'Verified!', text: 'Your email has been verified.', confirmButtonColor: '#198754' });
          window.location.href = '/account/signin';
        } else {
          await Swal.fire({ icon: 'error', title: 'Verification failed', text: data.message || 'Invalid or expired code.', confirmButtonColor: '#198754' });
          btn.disabled = false; btn.innerHTML = old;
        }
      } catch (err) {
        console.error(err);
        await Swal.fire({ icon: 'error', title: 'Error', text: 'Unable to verify right now. Please try again.', confirmButtonColor: '#198754' });
        btn.disabled = false; btn.innerHTML = old;
      }
    });
  }

  // Handle resend form submit with AJAX + SweetAlert2
  const resendForm = document.getElementById('resendForm');
  if (resendForm) {
    resendForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const btn = resendForm.querySelector('button[type="submit"]');
      const old = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
      try {
        const res = await fetch('/account/resend-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
          body: `email=${encodeURIComponent(email)}`
        });
        const data = await res.json();
        if (data.success) {
          await Swal.fire({ icon: 'success', title: 'Code sent', text: 'Please check your email inbox.', confirmButtonColor: '#198754'});
        } else {
          await Swal.fire({ icon: 'error', title: 'Cannot send code', text: data.message || 'Please try again later', confirmButtonColor: '#198754'});
        }
      } catch (err) {
        console.error(err);
        await Swal.fire({ icon: 'error', title: 'Error', text: 'Unable to send email right now.', confirmButtonColor: '#198754'});
      } finally {
        btn.disabled = false; btn.innerHTML = old;
      }
    });
  }
</script>
{{/fillContent}}
